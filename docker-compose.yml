version: '3.8'

# --- 1. INFRASTRUCTURE SERVICES (Database, Queue, Storage) ---
services:
  # PostgreSQL: Stores index (Full-Text Search)
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # Ports exposed only to internal network by default
    # ports:
    #   - "5432:5432" 
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - teaser_net

  # Migration Service
  migrate:
    image: migrate/migrate
    restart: on-failure
    volumes:
      - ./migrations:/migrations
    command: ["-path", "/migrations", "-database", "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable", "up"]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - teaser_net

  # Redis/Valkey: Queue
  redis:
    image: redis:7-alpine
    restart: always
    networks:
      - teaser_net
    # ports:
    #   - "6379:6379"

  # MinIO (Optional S3 Storage): Stores Raw HTML
  minio:
    image: quay.io/minio/minio:latest
    restart: always
    command: minio server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    volumes:
      - minio_data:/data
    # ports:
    #   - "9000:9000"
    #   - "9001:9001"
    networks:
      - teaser_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Meilisearch: Search Engine
  meilisearch:
    image: getmeili/meilisearch:latest
    restart: always
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
      MEILI_NO_ANALYTICS: "true"
      MEILI_EXPERIMENTAL_ENABLE_METRICS: "true" # Enable metrics
    volumes:
      - meili_data:/meili_data
    # ports:
    #   - "7700:7700"
    networks:
      - teaser_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 5s
      timeout: 1s
      retries: 30


  # --- 2. APPLICATION SERVICES (Go and Python) ---
  
  # Dashboard Backend (Go): API/Search Logic/Management
  backend:
    build: 
      context: ./go-backend
      dockerfile: Dockerfile
    restart: always
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      REDIS_HOST: redis:6379
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      # Mount Go source code to /app
      - ./go-backend:/app:rw
      # Share config with crawler
      - crawler_config:/app/crawler
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      migrate:
        condition: service_completed_successfully
    networks:
      - teaser_net

  # Crawler (Python): Data Collection and Enrichment
  crawler:
    build: 
      context: . 
      dockerfile: Dockerfile.Crawler
    restart: on-failure
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    volumes:
      # Mount root directory to /app for crawler
      - ./:/app
      # Ensure config path is consistent
      - crawler_config:/app/crawler
    ports:
      - "8000:8000" # Metrics
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      migrate:
        condition: service_completed_successfully
      minio:
        condition: service_started
    networks:
      - teaser_net

  # Indexer Worker (Python): Sync Postgres -> Meilisearch
  indexer_worker:
    build:
      context: .
      dockerfile: indexer/Dockerfile.Indexer
    restart: on-failure
    # command: python indexer.py # CMD already in Dockerfile
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      MEILI_HOST: http://meilisearch:7700
      MEILI_API_KEY: ${MEILI_MASTER_KEY}
    volumes:
       # Mount indexer directory for live-reload
      - ./indexer:/app
    ports:
      - "8001:8001" # Metrics
    depends_on:
      postgres:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - teaser_net

  # Dashboard Frontend (Next.js)
  dashboard:
    build:
      context: ./dashboard-frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    networks:
      - teaser_net
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://backend:8080
    # Live reload by mounting the source code
    # NOTE: node_modules is excluded via .dockerignore
    # Removed volume mounting to prevent overwriting the built /app directory
    # volumes:
    #   - ./dashboard-frontend:/app

  # New Service: Lith Ranker (Independent Ranking Algorithm)
  lith_ranker:
    build:
      context: ./lith-ranker # Path to Lith code directory
      dockerfile: Dockerfile
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
    environment:
      # Connect to same database as Crawler and Backend
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      LITH_INTERVAL_MINUTES: 60  # Recalculate every 60 minutes
      LITH_MAX_ITERATIONS: 20    # Number of iterations to converge
    depends_on:
      postgres:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - teaser_net

  # JS Renderer (Node.js + Playwright)
  js_renderer:
    build:
      context: ./js-renderer
      dockerfile: Dockerfile
    restart: on-failure
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
    ports:
      - "8888:8888"
    networks:
      - teaser_net

  # --- 3. OBSERVABILITY SERVICES ---
  
  prometheus:
    image: prom/prometheus:latest
    restart: always
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - teaser_net

  grafana:
    image: grafana/grafana:latest
    restart: always
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - teaser_net

  postgres-exporter:
    image: quay.io/prometheuscommunity/postgres-exporter
    restart: always
    environment:
      DATA_SOURCE_NAME: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?sslmode=disable
    networks:
      - teaser_net

  redis-exporter:
    image: oliver006/redis_exporter
    restart: always
    environment:
      REDIS_ADDR: redis:6379
    networks:
      - teaser_net

  node-exporter:
    image: prom/node-exporter
    restart: always
    networks:
      - teaser_net

# --- 4. VOLUMES and NETWORKS ---
volumes:
  postgres_data:
  minio_data:
  meili_data:
  crawler_config: # New shared volume for config

networks:
  teaser_net:
    driver: bridge
